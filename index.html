<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>websocket-non-blocking-cpp by akinaru</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">websocket-non-blocking-cpp</h1>
      <h2 class="project-tagline">websocket non-blocking server implementation in C++</h2>
      <a href="https://github.com/akinaru/websocket-non-blocking" class="btn">View on GitHub</a>
      <a href="https://github.com/akinaru/websocket-non-blocking/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/akinaru/websocket-non-blocking/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="websocket-non-blocking-server-library" class="anchor" href="#websocket-non-blocking-server-library" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Websocket non-blocking server library</h1>

<p><a href="https://travis-ci.org/akinaru/websocket-non-blocking"><img src="https://travis-ci.org/akinaru/websocket-non-blocking.svg?branch=master" alt="Build Status"></a>
<a href="LICENSE.md"><img src="http://img.shields.io/:license-mit-blue.svg" alt="License"></a></p>

<p><a href="http://akinaru.github.io/websocket-non-blocking/">http://akinaru.github.io/websocket-non-blocking/</a></p>

<p>C++ websocket non-blocking server library for Qt4/Qt5</p>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage</h2>

<p>Start websocket server :</p>

<pre><code>WebsocketServer server;

bool success = server.listen(QHostAddress("127.0.0.1"), 8443);
</code></pre>

<p>Stop websocket server :</p>

<pre><code>server.close();
</code></pre>

<h2>
<a id="integrate-in-your-project" class="anchor" href="#integrate-in-your-project" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Integrate in your project</h2>

<ul>
<li>from git submodule</li>
</ul>

<pre><code>git submodule add git://github.com/akinaru/websocket-non-blocking.git
</code></pre>

<p>and in your <code>project.pro</code> :</p>

<pre><code>TEMPLATE = subdirs
SUBDIRS = websocket-non-blocking your-app
your-app.depends = websocket-non-blocking
</code></pre>

<p>with in <code>your-app.pro</code> :</p>

<pre><code>TARGET = your-app
SOURCES = main.cpp
INCLUDEPATH += $$PWD/../websocket-non-blocking/libwebsocket/release
LIBS += -L$$PWD/../websocket-non-blocking/libwebsocket/release -lwebsocket
DEPENDPATH += $$PWD/../websocket-non-blocking/libwebsocket/release
</code></pre>

<h2>
<a id="monitor-clients" class="anchor" href="#monitor-clients" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Monitor clients</h2>

<p>Build your own client monitoring class that inherits <code>IClientEventListener</code> : </p>

<pre><code>class ClientSocketHandler :  public IClientEventListener
{
public:

    ClientSocketHandler();

    ~ClientSocketHandler();

    void onClientClose(IWebsocketClient &amp;client);

    void onClientConnection(IWebsocketClient &amp;client);

    void onMessageReceivedFromClient(IWebsocketClient &amp;client, std::string message);
};
</code></pre>

<p>Add listener to server instance : </p>

<pre><code>#include "ClientSockethandler.h"

....

ClientSocketHandler *clientHandler = new ClientSocketHandler();

server.addClientEventListener(clientHandler);
</code></pre>

<p>In this <code>ClientSocketHandler</code> you have 3 callbacks that will notify you on client connection change and arrival of client messages :</p>

<ul>
<li>
<code>void onClientClose(IWebsocketClient &amp;client);</code> notify when client socket close</li>
<li>
<code>void onClientConnection(IWebsocketClient &amp;client);</code> notify when client socket connect to server</li>
<li>
<code>void onMessageReceivedFromClient(IWebsocketClient &amp;client,std::string message);</code> notify when a socket client send a message to you</li>
</ul>

<p>You can send a message back with <code>IWebsocketClient</code> sent from the same callback with <code>sendMessage(std::string textToSend)</code> method :</p>

<pre><code>void ClientSocketHandler::onMessageReceivedFromClient(IWebsocketClient &amp;client,string message)
{
    cout &lt;&lt; "Client socket message received : " &lt;&lt; message.data() &lt;&lt; endl;

    client.sendMessage("OK I received your message !");
}
</code></pre>

<p>Check the client monitoring example <a href="./libwebsocket-test/ClientSocketHandler.cpp">here</a></p>

<h2>
<a id="ssl-secured-websocket-server" class="anchor" href="#ssl-secured-websocket-server" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>SSL secured websocket server</h2>

<pre><code>WebsocketServer server;

server.setSSL(true); // set SSL to true (default is false)
</code></pre>

<p>Then you set your public/private/ca certificates separately with respective methods : </p>

<pre><code>server.setPublicCert(SslHandler::retrieveCertFromFile(PUBLIC_CERT));
server.setPrivateCert(SslHandler::retrieveKeyCertFile(PRIVATE_CERT,PRIVATE_CERT_PASS));
server.setCaCert(SslHandler::retrieveveCaCertListFromFile(CA_CERTS));
</code></pre>

<p>You can use static method from <a href="./libwebsocket-test/SslHandler.cpp"><code>SslHandler</code></a> :</p>

<ul>
<li>public cert must be a QSslCertificate : <code>SslHandler::retrieveCertFromFile(char * filepath)</code>
</li>
<li>private cert must be a QSslKey : <code>SslHandler::retrieveKeyCertFile(char * filepath,char * passKey)</code>
</li>
<li>CA cert must be a QList of QSslCertificate : <code>SslHandler::retrieveveCaCertListFromFile(char * filepath)</code>
</li>
</ul>

<p>Eventually add event listener as described above and start websocket server : </p>

<pre><code>server.addClientEventListener(clientHandler);

bool success = server.listen(QHostAddress("127.0.0.1"), 8443);
</code></pre>

<h2>
<a id="troubleshooting-ssl-errors-with-local-browser-js-client" class="anchor" href="#troubleshooting-ssl-errors-with-local-browser-js-client" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Troubleshooting SSL errors with local browser JS client</h2>

<blockquote>
<p>Bad certificate | Unknown CA errors</p>
</blockquote>

<p>This could mean you didn't import your not-trusted-CA certificate into your browser.</p>

<blockquote>
<p>The remote host closed the connection</p>
</blockquote>

<p>Just load your URL with "https" : <a href="https://127.0.0.1:8443">https://127.0.0.1:8443</a> . Browser will prompt you to accept the certificates and it will probably solve your connection error.</p>

<h2>
<a id="debugging-ssl-connection-error" class="anchor" href="#debugging-ssl-connection-error" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Debugging SSL connection error</h2>

<p>use openssl command line tool to debug ssl connection : </p>

<pre><code>openssl s_client -connect 127.0.0.1:8443
</code></pre>

<h2>
<a id="server-client-keycert-generation" class="anchor" href="#server-client-keycert-generation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Server-Client key/cert generation</h2>

<p>Sample certs are in <a href="./libwesocket-test/certs">libwesocket-test/certs</a> folder, you will find server,client and ca cert build with easy-rsa :</p>

<p><a href="https://github.com/OpenVPN/easy-rsa">https://github.com/OpenVPN/easy-rsa</a></p>

<p>With last release of easy-rsa, you can build your own key with the following : </p>

<ul>
<li>
<code>./build-ca</code> : generate a new CA for you</li>
<li>
<code>./build-server-full myServer</code> : will build for you public cert and private cert signed with CA for server</li>
<li>
<code>./build-client-full myClient</code> : will build for you public cert and private cert signed with CA for client</li>
</ul>

<h2>
<a id="build-library--examples" class="anchor" href="#build-library--examples" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Build library &amp; examples</h2>

<pre><code>qmake
make
</code></pre>

<h2>
<a id="run-examples" class="anchor" href="#run-examples" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Run examples</h2>

<p>Open a websocket on port 8443 :</p>

<pre><code>./libwebsocket-test/release/libwebsocket-test 127.0.0.1 8443
</code></pre>

<p>Open Javascript clients located in <a href="./client-test/js">client-test/js</a> :</p>

<hr>

<p><img src="./img/clientSide.png" alt="client side"></p>

<hr>

<p><img src="./img//serverSide.png" alt="server side"></p>

<h2>
<a id="valgrind-checking" class="anchor" href="#valgrind-checking" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Valgrind checking</h2>

<pre><code>cd libwebsocket-test/release

valgrind --tool=memcheck --leak-check=full --suppressions=../../memcheck.suppress ./libwebsocket-test &lt;ip&gt; &lt;port&gt;

</code></pre>

<h2>
<a id="compatibility" class="anchor" href="#compatibility" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Compatibility</h2>

<ul>
<li>Qt4</li>
<li>Qt5</li>
</ul>

<h2>
<a id="specification" class="anchor" href="#specification" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Specification</h2>

<ul>
<li><a href="https://tools.ietf.org/html/rfc6455">https://tools.ietf.org/html/rfc6455</a></li>
</ul>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/akinaru/websocket-non-blocking">websocket-non-blocking-cpp</a> is maintained by <a href="https://github.com/akinaru">akinaru</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-62569105-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
